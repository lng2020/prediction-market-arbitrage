当然可以。为了确保 AI 编程的效率和准确性，我将输出一份结构化的**项目需求文档（PRD）**。这份文档将明确定义项目目标、技术栈、核心模块和具体功能规范，以便任何 AI 或人类开发者能够快速理解和实现这套 Kalshi/Polymarket 跨平台套利系统。

-----

# 🤖 Kalshi/Polymarket 跨平台套利机器人项目需求文档 (PRD)

## 1\. 项目目标与概览

### 1.1 目标

开发一套高性能、低延迟的 Python 交易系统，旨在通过捕捉 **Kalshi** 和 **Polymarket** 平台上相同事件互斥结果的隐含概率之和小于 $1$ ($\sum P < 1$) 的机会，实现无风险或低风险的跨平台套利。

### 1.2 平台定义

| 平台名称 | 角色 | 特点 | 合约示例 |
| :--- | :--- | :--- | :--- |
| **Polymarket** (PM) | **平台 A** (低流动性) | 去中心化，价差可能更大，适合挂 **Maker** 单以获取最优价。 | `NBA_TEAM_X_WINS_PM` |
| **Kalshi** (KL) | **平台 B** (高流动性) | 中心化，流动性好，适合下 **Taker** 单进行快速对冲。 | `NBA_TEAM_Y_WINS_KL` |

### 1.3 技术要求

  * **编程语言:** Python 3.9+
  * **核心库:** `asyncio` (用于并发和低延迟 I/O), 平台官方 API 客户端/SDK。
  * **架构:** 事件驱动/异步架构。

-----

## 2\. 核心功能模块

### 2.1 模块 A：数据采集与实时报价 (`DataCollector`)

| ID | 功能 | 描述 | 输入 | 输出 |
| :--- | :--- | :--- | :--- | :--- |
| **A.1** | **API 连接管理** | 初始化并管理与 PM 和 KL 的 API 连接（REST/WebSocket）。 | API 密钥、密钥对、URL。 | 连接状态。 |
| **A.2** | **实时报价获取** | 通过 **WebSocket** 或高频轮询（高优）获取指定合约的实时最佳买卖价 (`Bid`/`Ask`) 和流动性 (`Size`)。 | `Contract ID` (PM, KL)。 | `Quote Data` (字典): `{'ask': price, 'bid': price, 'size': volume}`。 |
| **A.3** | **事件/合约映射** | 维护 PM 和 KL 之间对应互斥事件的合约 ID 映射表。 | N/A | 映射表 (`dict`)。 |

### 2.2 模块 B：套利机会计算 (`ArbitrageFinder`)

| ID | 功能 | 描述 | 输入 | 输出 |
| :--- | :--- | :--- | :--- | :--- |
| **B.1** | **净成本计算** | 计算单笔交易的实际总成本，必须考虑交易费用。 | PM `Ask`, KL `Ask`, PM `Maker Fee`, KL `Taker Fee`。 | `Net Cost` (float)。 |
| **B.2** | **T2T 模式分析** | 计算 **Taker + Taker** 模式下的净利润率。 | 实时报价 (`Ask`)。 | `Profit Rate` (float)。 |
| **B.3** | **M2T 模式分析** | 计算 **Maker + Taker** 模式下的潜在净利润率，使用预设的 **目标 Maker 价格**。 | 实时报价 (`Ask`, `Bid`), `Target Maker Price`。 | `Potential Profit Rate` (float)。 |
| **B.4** | **最小利润筛选** | 仅返回高于预设 **最低利润阈值** ($\geq 0.3\%$) 的机会。 | `Profit Rate`, `MIN_PROFIT_TARGET`。 | `Opportunity` (True/False)。 |

### 2.3 模块 C：交易执行与风险管理 (`TradeExecutor`)

这是最关键、风险最高的模块，必须使用 **`asyncio`** 实现。

| ID | 模式 | 描述 | 关键操作 | 风险控制 |
| :--- | :--- | :--- | :--- | :--- |
| **C.1** | **M2T (高优)** | **PM Maker 买入** -\> **KL Taker 对冲**。优先执行。 | 1. PM 下 **Limit Buy** (Maker)。<br>2. **异步等待** Maker 成交。<br>3. 成交后，立即 KL 下 **Market Buy** (Taker)。 | **核心:** 若 Maker 成交但 Taker 失败，必须立即触发 **C.3 紧急平仓**。 |
| **C.2** | **T2T** | **PM Taker 买入** -\> **KL Taker 对冲**。次优选择，用于 Maker 超时或 T2T 利润足够高时。 | 1. 几乎同时 (或串行极快) 在 PM 和 KL 下 **Market Buy** (Taker)。 | 需检查两个订单状态，若一个成功另一个失败，立即触发 **C.3 紧急平仓**。 |
| **C.3** | **紧急平仓** (Panic Sell) | 应对 Maker/Taker 流程中产生的**单边仓位风险**。 | **立即**以 **Market Sell** 在持有仓位的平台平仓。 | 速度必须最快，接受滑点亏损以消除风险。 |
| **C.4** | **订单状态追踪** | 实时轮询或监听订单状态，确保交易流程的正确推进。 | 轮询/监听 API 接口。 | 记录所有订单状态变化，用于审计和异常处理。 |

-----

## 3\. 交易逻辑与决策流程

系统的核心循环应遵循以下逻辑：

1.  **数据获取:** 循环调用 A.2 获取 PM 和 KL 的实时报价。
2.  **机会判断:** 调用 B.2 和 B.3 计算 M2T 和 T2T 的净利润率。
3.  **决策优先级:**
      * **IF** M2T 净利润率 $\geq$ `MIN_PROFIT_TARGET`:
          * 执行 C.1 (M2T 流程)。
      * **ELSE IF** M2T 失败或超时，且 T2T 净利润率 $\geq$ `MIN_PROFIT_TARGET`:
          * 执行 C.2 (T2T 流程)。
      * **ELSE:**
          * 等待下一轮循环。

## 4\. 关键风险与待办事项 (TO-DO)

| 风险/待办事项 | 描述 | 解决方案 (AI 需实现) |
| :--- | :--- | :--- |
| **网络延迟** | 延迟是套利的最大威胁，可能导致套利窗口关闭或对冲失败。 | 强制使用 `asyncio` 和 **WebSocket** 接口获取报价和执行订单。 |
| **API 限制** | 高频查询可能触发平台的 API 速率限制。 | 实施令牌桶或漏桶算法，严格控制查询频率。 |
| **滑点** | 在执行 `Taker` 或 **紧急平仓** 时，可能因流动性不足导致成交价高于报价。 | 在 B.1 成本计算时，为 Taker 价格增加一个预估滑点缓冲。 |
| **资金分配** | 如何在两个平台分配资金以实现完美对冲。 | 每次交易量应基于 `CAPITAL_PER_TRADE` 和当前合约价格计算，确保两端对冲量相等（例如：购买 100 份合约）。 |